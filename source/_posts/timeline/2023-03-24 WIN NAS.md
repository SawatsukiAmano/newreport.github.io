---
title: WIN NAS 的安装及使用
date: 2023-03-24 00:00:00 # 时间
tags: # 标签
- NAS
urlname: windows-server-2022-nas-init
categories:  timeline
---
> 本想用 freenas 或者是黑群晖这些基于 linux 的来搭建，但是大部分 nas 系统没有虚拟机，黑裙有但不稳定，白裙那配置和价格，算了算了。  

> 用 pve 或者 exsi 又太重了，我的需求仅仅是下 BT/PT 和存储一些项目文件，docker 跑些应用内网穿透出去就可，而且虚拟化平台连接 WiFi 是个问题。  

> 选来选去，看着 b 站知乎一堆推荐如上 NAS 的，自己装了好几个用了下，不太行，最后看见有人推荐 WIN NAS，我也问了下玩 NAS 的朋友，也用的 WIN 做 NAS，遂开装。

> 系统直接选 WIN Server 2022，驱动装好可以连 WIFI，机器直接丢阳台或者隔墙，WIFI6 日常用速度肯定够的，虚拟机有 hyper-v，存储有自带的存储池，可以做 refs（单盘 raid5）或者固态加速机械，组多盘 raid 都没问题，有图形化，这配置单 U 功耗顶天 **100W**，闲时还能接屏幕玩下 101 和雀魂都是没问题的，唯一的缺点就是 docker 用起来麻烦点。

# 硬件
## 配置
| 类型     | 名称                  | 价格 | 来源       |
| -------- | --------------------- | ---- | ---------- |
| CPU      | 5700G 8c16t           | 0    | ITX拆机    |
| 散热     | 利民AXP120            | 0    | ITX拆机    |
| GPU      | Vega8                 | 0    | 核显       |
| 主板     | 华硕 B550m PLUS(WIFI) | 0    | ITX拆机    |
| 内存     | 光威16G*4 DDR4 3200   | 0    | ITX拆机    |
| 硬盘     | 凯侠 RC20             | 0    | ITX拆机    |
| 硬盘1    | 台电1T                | 0    | ITX拆机    |
| 电源     | 海韵650W              | 0    | 另一台拆机 |
| 机箱     | 长城阿基米德7B        | 360  |            |
| 机箱风扇 | id-coolding 14cm      | 33   |            |
| 合计     | -                     | 643  |            |


### 供电
硬盘坏的原因无非有三，供电不稳或不足、碰撞震动及 roll 到了  
机械 18T 单盘峰值可以到 28W，13*30W 算为 390W，CPU 给电 150W，其他给电 50W，650W 在峰值时刚好，日常没这么高  
然后是噪音，4k 读写 30min，来到了 50 分贝

## 容量和速度
> 机械盘的随机读基本忽略吧，几 MB/s 不用测根本不可能跑满接口  
然后是顺序读写，13 块盘同时读写不可能，虽然硬盘顺序峰值能到 270MB/s，但是日常没那么高，这里按照每块盘 100MB/s 算，也算是很高的负载了  

### PCIE
> [主板](https://www.asus.com/tw/motherboards-components/motherboards/tuf-gaming/tuf-gaming-b550m-plus-wi-fi/techspec/)   
3 个 PCIE 槽，PCIE 4.0\*16 和 PCIE 3.0\*16（芯片组） 和 PCIE 3.0\*1（芯片组），硬件接口分别为 PCIE 16、PCIE 16、PCIE 1 展示    
2 个 M.2 插槽，PCIE 4.0\*4（CPU直连）和 PCIE 3.0\*4（芯片组）
4 个 SATA 插槽（芯片组）

> [CPU](https://www.amd.com/en/product/11171)  有 24 条 PCIE 3.0，第一个 PCIE 占用 16 条，第一个 M.2 占用 4 条，南桥（芯片组）占用 4 条，即

| PCIE 版本\通道 | x1        | x4         | x8         | x16        |
| -------------- | --------- | ---------- | ---------- | ---------- |
| 1.0            | 250MB/s   | 1GB/s      | 2GB/s      | 4GB/s      |
| 2.0            | 500MB/s   | 2GB/s      | 4GB/s      | 8GB/s      |
| 3.0            | 984.6MB/s | 3.938GB/s  | 7.877GB/s  | 15.754GB/s |
| 4.0            | 1.969GB/s | 7.877GGB/s | 15.754GB/s | 31.508GB/s |
| 5.0            | 3.9GB/s   | 15.8GB/s   | 31.5GB/s   | 63GB/s     |

主板直连 PCIE 4.0 \*16 和 （M.2）PCIE 4.0 \*4  即最大速度约为 **40GB/s**
 
主板南桥 PCIE 3.0 \*4，即芯片组的最大速度约为 **4GB/s**

CPU的 PCIE 3.0 \*24 最大速度约为 **24GB/s**

机械盘速度目前顺序读能到 100MB/s，最大不会超过 250MB/s，4k 随机速度可以忽略，所以南桥扩展 sata 给机械盘就够用了，日常根本不会跑满

### [机箱](https://item.jd.com/100022763272.html#product-detail)
支持 13 个 3.5 盘，2 个 2.5 盘位。最大容量为 248T + 6T  

机械硬盘（单价1200） 二手企业级机械算 13*18T=**234T（100MB/s）**  

sata 固态（单价800） 固态 2*3T=**6T(500MB/s)**

<!-- more -->
### [主板](https://www.asus.com/tw/motherboards-components/motherboards/tuf-gaming/tuf-gaming-b550m-plus-wi-fi/techspec/)   
* 直连CPU 15GB/s(CPU阈值 24GB/s)
    * M.2_1（PCIE 4.0x4）：凯侠 RC20 **1T（3GB/s）** ，系统盘
    * PCIE_1（PCIE 4.0x16）：[扩展卡](https://item.jd.com/10021208284029.html) 拆分为 PCIE 3.0(3GB/s) \*4 的 4 个 2T 的 3.0 M.2 硬盘，即 **8T（12G/s）**


* 南桥 234T  合计峰值 3 GB/s (芯片组阈值 4GB/s）
    * M.2_2：台电 **1T（2GB/s)**，每天为系统盘做备份，磁盘忽略
    * PCIE_2（PCIE 3.0x4）：9271 8i 阵列卡 + 扩展卡 82885t
        * 13*18T=**180T（1.3GB/s）**，即单口 750MB/s，总共 2.5GB/s，对于机械盘完全够用，机械顺序跑满按 150MB/s，13 盘才 2GB/s
    * 主板 sata：4 口 6Gb/s 接口，即和扩展卡一样
        * 2 sata 固态 6T **（1GB/s）**



## 硬盘分配
> 使用 9271 8i 阵列卡接入南桥，使用 82885t 作为扩展卡，机械盘以 250MB/s 计算，固态以 3GB/s 计算

| 存储池        | 硬件                                                | 容量 | 速度            | 功能             |
| ------------- | --------------------------------------------------- | ---- | --------------- | ---------------- |
| 系统盘        | 凯侠 RC20                                           | 1T   | 3GB/s           | 软件默认装系统盘 |
| 系统盘备份    | 台电                                                | 1T   | 2GB/s（日常 0） | 每日备份         |
| 软存储池1     | 2T*2 的 PCIE 3.0 固态                               | 4T   | 6GB/s           | 开发测试环境数据 |
| 软硬存储池1   | 2T*2 的 3.0 固态 + 18T*4（硬raid10） 的机械分层储池 | 36T  | 6GB/s~0.5GB/s   | 生产环境数据     |
| 硬存储池1     | 18T*4(3+1)=54T 的机械盘硬 raid5                     | 54T  | 750MB/s         | nas-tools 影视库 |
| 硬存储池2     | 18T*4(3+1)=54T 的机械盘硬 raid5                     | 54T  | 750MB/s         | 内网共享文件     |
| 裸盘机械1     | NTFS                                                | 18T  | 250MB/s         | 游戏冷备         |
| 裸盘sata固态1 | NTFS                                                | 3T   | 500MB/s         | 游戏             |
| 裸盘sata固态2 | NTS                                                 | 3T   | 500MB/s         | 其他文件         |

# 系统安装
[Windows Server DataCenter 2022](https://www.microsoft.com/zh-cn/evalcenter/download-windows-server-2022)

[写盘工具](https://rufus.ie/)

> 开机自启路径
```dos
C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup
```

## 内网穿透
[nps](https://github.com/ehang-io/nps/releases)

新建 bat，然后快捷方式丢到开机路径里

## 开机自动登录
> win+r 运行 regedit 注册表
```dos
计算机\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\PasswordLess\Device
```
DevicePasswordLessBuildVersion改为 0

> win+r 运行 netplwiz，取消掉必须输入选框

## WSL2
在服务器管理里添加角色和功能里打开 hyper-v，然后在命令行输入 wsl --install，之后重启，重启完继续 wsl --install，然后 wsl -l -v 查看版本为 2 即安装成功

# 应用

## 应用程序
|名称|功能|备注|
|---|---|---|
|[7z](https://www.7-zip.org/)|解压压缩||
|[Docker](https://docs.docker.com/get-docker/)|容器服务| 务必装好 WSL2|
|[Todesk](https://www.todesk.com/download.html)|||
|Clash||||
|[ILSpy](https://github.com/icsharpcode/ILSpy/releases)|||
|[VS](https://visualstudio.microsoft.com/)|.NET、C#、C++ 全家桶|
|[VS Code](https://code.visualstudio.com/Download)|||
|[Postmam](https://www.postman.com/)|api、grpc、socket、mq调试||
|[MQTT X](https://mqttx.app/)|||
|[AnotherRedisDesktopManager](https://github.com/qishibo/AnotherRedisDesktopManager/releases)|redis GUI||
|[Navicat](https://navicat.com)|||
|[Goland](https://www.jetbrains.com/go/)|||

## Docker 服务
|名称|功能|备注|
|---|---|---|
| MySQL|||
|Redis|||
|MongDB|||
|RabbitMQ|||
|Superset|||
|Nginx Proxy Manager|||
|Portainer|||

## VS Code 插件